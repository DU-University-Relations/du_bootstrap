name: DU Bootstrap Theme Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout theme
        uses: actions/checkout@v4
        with:
          path: theme

      - name: Create test directory
        run: |
          mkdir drupal-test
          cd drupal-test

      - name: Install DDEV
        working-directory: drupal-test
        run: |
          curl -fsSL https://ddev.com/install.sh | bash
          ddev --version

      - name: Setup Docker
        working-directory: drupal-test
        run: |
          docker --version
          docker compose version

      - name: Configure and start DDEV
        working-directory: drupal-test
        run: |
          ddev config --project-type=drupal10 --docroot=web --create-docroot
          ddev start

      - name: Install Drupal
        working-directory: drupal-test
        run: |
          # Create fresh Drupal project
          ddev composer create --no-install "drupal/recommended-project:^10"

          # Configure Composer
          ddev composer config minimum-stability dev
          ddev composer config prefer-stable true

          # Allow plugins
          ddev composer config allow-plugins true --no-plugins

          # Install core and required modules
          ddev composer require --no-update "drupal/core:^10"
          ddev composer require --no-update "drupal/core-recommended:^10"
          ddev composer require --no-update "drupal/core-composer-scaffold:^10"
          ddev composer require --no-update "drupal/core-project-message:~10.3.2"
          ddev composer require --no-update "drush/drush:^12"

          # Install theme and its direct dependencies
          ddev composer require --no-update drupal/bootstrap:^5.0
          ddev composer require --no-update drupal/admin_toolbar
          ddev composer require --no-update drupal/paragraphs
          ddev composer require --no-update drupal/video_embed_field
          ddev composer require --no-update drupal/menu_item_extras
          ddev composer require --no-update drupal/entity_browser
          ddev composer require --no-update drupal/link_attributes
          ddev composer require --no-update drupal/svg_image
          ddev composer require --no-update drupal/entity_reference_revisions
          ddev composer require --no-update drupal/allowed_formats

          # Install ducore profile required modules
          ddev composer require --no-update drupal/components
          ddev composer require --no-update drupal/config_filter
          ddev composer require --no-update drupal/config_ignore
          ddev composer require --no-update drupal/config_profile
          ddev composer require --no-update drupal/config_split
          ddev composer require --no-update drupal/config_update
          ddev composer require --no-update drupal/content_lock
          ddev composer require --no-update drupal/ctools
          ddev composer require --no-update drupal/diff
          ddev composer require --no-update drupal/entity
          ddev composer require --no-update drupal/entity_block
          ddev composer require --no-update drupal/entity_browser_block
          ddev composer require --no-update drupal/entity_clone
          ddev composer require --no-update drupal/entity_embed
          ddev composer require --no-update drupal/environment_indicator
          ddev composer require --no-update drupal/field_group
          ddev composer require --no-update drupal/honeypot
          ddev composer require --no-update drupal/libraries
          ddev composer require --no-update drupal/linkit
          ddev composer require --no-update drupal/metatag
          ddev composer require --no-update drupal/pantheon_advanced_page_cache
          ddev composer require --no-update drupal/pantheon_autopilot_toolbar
          ddev composer require --no-update drupal/pathauto
          ddev composer require --no-update drupal/rabbit_hole
          ddev composer require --no-update drupal/redirect
          ddev composer require --no-update drupal/simple_sitemap
          ddev composer require --no-update drupal/twig_field_value
          ddev composer require --no-update drupal/twig_tweak
          ddev composer require --no-update drupal/url_redirect
          ddev composer require --no-update drupal/webform
          ddev composer require --no-update drupal/simplesamlphp_auth
          ddev composer require --no-update drupal/dropzonejs
          ddev composer require --no-update drupal/ebrsww
          ddev composer require --no-update drupal/file_browser
          ddev composer require --no-update drupal/ds
          ddev composer require --no-update drupal/node_revision_delete
          ddev composer require --no-update drupal/key
          ddev composer require --no-update drupal/pantheon_secrets
          ddev composer require --no-update drupal/blazy
          ddev composer require --no-update drupal/slick
          ddev composer require --no-update drupal/token_filter
          ddev composer require --no-update drupal/quick_node_clone
          ddev composer require --no-update drupal/views_json_source
          ddev composer require --no-update drupal/editoria11y
          ddev composer require --no-update drupal/simplesamlphp_custom_attributes
          ddev composer require --no-update drupal/role_expire

          # Update everything
          ddev composer update --with-all-dependencies

      - name: Copy DU Core profile
        working-directory: drupal-test
        run: |
          # Create profiles directory if it doesn't exist
          mkdir -p web/profiles/custom

          # Clone the ducore profile
          git clone https://github.com/University-of-Denver/drupal-composer-managed.git temp
          cp -r temp/web/profiles/custom/ducore web/profiles/custom/
          rm -rf temp

      - name: Install site
        working-directory: drupal-test
        run: |
          # Install Drupal using ducore profile
          ddev exec drush site:install ducore \
            --account-name=admin \
            --account-pass=admin \
            --site-name="Test Site" \
            --yes

          # Enable theme
          ddev exec drush theme:enable du_bootstrap
          ddev exec drush config-set system.theme default du_bootstrap -y
          ddev exec drush cr
